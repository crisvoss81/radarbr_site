# rb_ingestor/youtube_integration.py
"""
Sistema para integra칞칚o autom치tica de v칤deos do YouTube
"""
import re
import requests
from urllib.parse import urlparse, parse_qs
from django.conf import settings
import logging

logger = logging.getLogger(__name__)

class YouTubeIntegration:
    """Sistema para detectar e incorporar v칤deos do YouTube automaticamente"""
    
    def __init__(self):
        # Padr칫es para detectar v칤deos do YouTube
        self.youtube_patterns = [
            r'youtube\.com/watch\?v=([a-zA-Z0-9_-]{11})',
            r'youtu\.be/([a-zA-Z0-9_-]{11})',
            r'youtube\.com/embed/([a-zA-Z0-9_-]{11})',
            r'youtube\.com/v/([a-zA-Z0-9_-]{11})',
            r'youtube\.com/user/[^/]+/.*#p/u/\d+/([a-zA-Z0-9_-]{11})',
        ]
        
        # Palavras-chave que indicam presen칞a de v칤deo
        self.video_keywords = [
            'v칤deo', 'video', 'youtube', 'assista', 'veja', 'confira',
            'grava칞칚o', 'gravacao', 'filmagem', 'filmado', 'gravado',
            'transmiss칚o', 'transmissao', 'ao vivo', 'live', 'streaming'
        ]
    
    def extract_video_id(self, text):
        """
        Extrai ID do v칤deo do YouTube do texto
        """
        text_lower = text.lower()
        
        for pattern in self.youtube_patterns:
            match = re.search(pattern, text_lower)
            if match:
                video_id = match.group(1)
                logger.info(f"游꿘 V칤deo do YouTube detectado: {video_id}")
                return video_id
        
        return None
    
    def has_video_mention(self, text):
        """
        Verifica se o texto menciona v칤deos
        """
        text_lower = text.lower()
        
        for keyword in self.video_keywords:
            if keyword in text_lower:
                return True
        
        return False
    
    def search_related_video(self, topic, max_results=1):
        """
        Busca v칤deos relacionados ao tema no YouTube
        """
        try:
            # Usar YouTube Data API v3 se dispon칤vel
            if hasattr(settings, 'YOUTUBE_API_KEY') and settings.YOUTUBE_API_KEY:
                return self._search_with_api(topic, max_results)
            else:
                # Fallback: buscar v칤deos populares relacionados
                return self._search_popular_videos(topic)
                
        except Exception as e:
            logger.error(f"Erro ao buscar v칤deos relacionados: {e}")
            return None
    
    def _search_with_api(self, topic, max_results):
        """
        Busca v칤deos usando YouTube Data API
        """
        try:
            api_key = settings.YOUTUBE_API_KEY
            search_url = "https://www.googleapis.com/youtube/v3/search"
            
            params = {
                'part': 'snippet',
                'q': f"{topic} brasil",
                'type': 'video',
                'maxResults': max_results,
                'order': 'relevance',
                'key': api_key
            }
            
            response = requests.get(search_url, params=params, timeout=10)
            response.raise_for_status()
            
            data = response.json()
            
            if 'items' in data and data['items']:
                video = data['items'][0]
                video_id = video['id']['videoId']
                title = video['snippet']['title']
                
                logger.info(f"游꿘 V칤deo relacionado encontrado: {title}")
                return {
                    'id': video_id,
                    'title': title,
                    'source': 'youtube_api'
                }
            
        except Exception as e:
            logger.error(f"Erro na API do YouTube: {e}")
        
        return None
    
    def _search_popular_videos(self, topic):
        """
        Fallback: retorna v칤deos populares relacionados ao tema
        """
        # V칤deos populares brasileiros por categoria
        popular_videos = {
            'economia': 'dQw4w9WgXcQ',  # Exemplo - substituir por v칤deos reais
            'pol칤tica': 'dQw4w9WgXcQ',
            'tecnologia': 'dQw4w9WgXcQ',
            'esportes': 'dQw4w9WgXcQ',
            'sa칰de': 'dQw4w9WgXcQ',
            'lazer': 'dQw4w9WgXcQ',
            'meio ambiente': 'dQw4w9WgXcQ',
            'mundo': 'dQw4w9WgXcQ',
            'brasil': 'dQw4w9WgXcQ'
        }
        
        topic_lower = topic.lower()
        
        for category, video_id in popular_videos.items():
            if category in topic_lower:
                logger.info(f"游꿘 V칤deo popular encontrado para {category}")
                return {
                    'id': video_id,
                    'title': f"V칤deo relacionado a {category}",
                    'source': 'popular_fallback'
                }
        
        return None
    
    def generate_embed_code(self, video_id, title="V칤deo Relacionado"):
        """
        Gera c칩digo HTML para embed do YouTube
        """
        embed_code = f'''
        <div class="youtube-video-container" style="margin: 20px 0; text-align: center;">
            <div class="video-wrapper" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; background: #000;">
                <iframe 
                    src="https://www.youtube.com/embed/{video_id}?rel=0&modestbranding=1&showinfo=0" 
                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;"
                    allowfullscreen
                    title="{title}">
                </iframe>
            </div>
            <p class="video-caption" style="margin-top: 10px; font-size: 14px; color: #666; font-style: italic;">
                游닠 {title}
            </p>
        </div>
        '''
        
        return embed_code
    
    def integrate_video_into_content(self, content, topic, article_title="", news_article=None):
        """
        Integra v칤deo do YouTube no conte칰do do artigo baseado na not칤cia original
        """
        # 1. Verificar se j치 existe v칤deo no conte칰do
        if 'youtube.com/embed' in content or 'youtu.be' in content:
            logger.info("游꿘 V칤deo j치 presente no conte칰do")
            return content
        
        # 2. PRIORIDADE M츼XIMA: Extrair v칤deo da not칤cia original
        if news_article:
            # Tentar extrair v칤deo da URL da not칤cia original
            news_url = news_article.get('url', '')
            if news_url:
                video_id = self.extract_video_id(news_url)
                if video_id:
                    logger.info(f"游꿘 V칤deo da not칤cia original: {video_id}")
                    embed_code = self.generate_embed_code(video_id, "V칤deo da Not칤cia Original")
                    
                    # Inserir v칤deo ap칩s o primeiro par치grafo
                    paragraphs = content.split('</p>')
                    if len(paragraphs) > 1:
                        paragraphs.insert(1, embed_code)
                        return '</p>'.join(paragraphs)
                    else:
                        return content + embed_code
            
            # Tentar extrair v칤deo do t칤tulo/descri칞칚o da not칤cia
            news_title = news_article.get('title', '')
            news_description = news_article.get('description', '')
            news_text = f"{news_title} {news_description}"
            
            video_id = self.extract_video_id(news_text)
            if video_id:
                logger.info(f"游꿘 V칤deo encontrado na not칤cia original: {video_id}")
                embed_code = self.generate_embed_code(video_id, "V칤deo da Not칤cia Original")
                
                # Inserir v칤deo ap칩s o primeiro par치grafo
                paragraphs = content.split('</p>')
                if len(paragraphs) > 1:
                    paragraphs.insert(1, embed_code)
                    return '</p>'.join(paragraphs)
                else:
                    return content + embed_code
        
        # 3. FALLBACK: Tentar extrair v칤deo do conte칰do gerado
        video_id = self.extract_video_id(content)
        
        if video_id:
            logger.info(f"游꿘 V칤deo extra칤do do conte칰do gerado: {video_id}")
            embed_code = self.generate_embed_code(video_id, "V칤deo Relacionado")
            
            # Inserir v칤deo ap칩s o primeiro par치grafo
            paragraphs = content.split('</p>')
            if len(paragraphs) > 1:
                paragraphs.insert(1, embed_code)
                return '</p>'.join(paragraphs)
            else:
                return content + embed_code
        
    def integrate_video_into_content(self, content, topic, article_title="", news_article=None):
        """
        Integra v칤deo do YouTube APENAS se a not칤cia original tiver v칤deo
        """
        # 1. Verificar se j치 existe v칤deo no conte칰do
        if 'youtube.com/embed' in content or 'youtu.be' in content:
            logger.info("游꿘 V칤deo j치 presente no conte칰do")
            return content
        
        # 2. PRIORIDADE M츼XIMA: Extrair v칤deo da not칤cia original
        if news_article:
            # Tentar extrair v칤deo da URL da not칤cia original
            news_url = news_article.get('url', '')
            if news_url:
                video_id = self.extract_video_id(news_url)
                if video_id:
                    logger.info(f"游꿘 V칤deo da not칤cia original: {video_id}")
                    embed_code = self.generate_embed_code(video_id, "V칤deo da Not칤cia Original")
                    
                    # Inserir v칤deo ap칩s o primeiro par치grafo
                    paragraphs = content.split('</p>')
                    if len(paragraphs) > 1:
                        paragraphs.insert(1, embed_code)
                        return '</p>'.join(paragraphs)
                    else:
                        return content + embed_code
            
            # Tentar extrair v칤deo do t칤tulo/descri칞칚o da not칤cia
            news_title = news_article.get('title', '')
            news_description = news_article.get('description', '')
            news_text = f"{news_title} {news_description}"
            
            video_id = self.extract_video_id(news_text)
            if video_id:
                logger.info(f"游꿘 V칤deo encontrado na not칤cia original: {video_id}")
                embed_code = self.generate_embed_code(video_id, "V칤deo da Not칤cia Original")
                
                # Inserir v칤deo ap칩s o primeiro par치grafo
                paragraphs = content.split('</p>')
                if len(paragraphs) > 1:
                    paragraphs.insert(1, embed_code)
                    return '</p>'.join(paragraphs)
                else:
                    return content + embed_code
        
        # 3. FALLBACK: Tentar extrair v칤deo do conte칰do gerado
        video_id = self.extract_video_id(content)
        
        if video_id:
            logger.info(f"游꿘 V칤deo extra칤do do conte칰do gerado: {video_id}")
            embed_code = self.generate_embed_code(video_id, "V칤deo Relacionado")
            
            # Inserir v칤deo ap칩s o primeiro par치grafo
            paragraphs = content.split('</p>')
            if len(paragraphs) > 1:
                paragraphs.insert(1, embed_code)
                return '</p>'.join(paragraphs)
            else:
                return content + embed_code
        
        # 4. Se n칚o encontrou v칤deo na not칤cia original, n칚o incluir nada
        logger.info("游꿘 Nenhum v칤deo encontrado na not칤cia original - n칚o incluindo v칤deo")
        return content
    
    def _should_include_related_video(self, topic, content):
        """
        Determina se deve incluir v칤deo relacionado baseado na relev칙ncia
        """
        topic_lower = topic.lower()
        content_lower = content.lower()
        
        # Temas que SEMPRE se beneficiam de v칤deo
        video_beneficial_topics = [
            'tutorial', 'como fazer', 'guia', 'dicas', 'passo a passo',
            'pescaria', 'pesca', 'ca칞a', 'camping', 'trilha', 'escalada',
            'culin치ria', 'culinaria', 'receita', 'cozinha',
            'exerc칤cio', 'exercicio', 'treino', 'fitness',
            'arte', 'desenho', 'pintura', 'm칰sica', 'musica',
            'jardinagem', 'plantas', 'horta'
        ]
        
        # Verificar se o tema se beneficia de v칤deo
        for keyword in video_beneficial_topics:
            if keyword in topic_lower:
                return True
        
        # Verificar se o conte칰do menciona v칤deos
        if self.has_video_mention(content):
            return True
        
        # Verificar se o conte칰do 칠 educativo/informativo
        educational_keywords = [
            'aprender', 'ensinar', 'demonstrar', 'mostrar', 'explicar',
            't칠cnica', 'tecnica', 'm칠todo', 'metodo', 'processo',
            'instru칞칚o', 'instrucao', 'orienta칞칚o', 'orientacao'
        ]
        
        for keyword in educational_keywords:
            if keyword in content_lower:
                return True
        
        # Para temas muito espec칤ficos ou t칠cnicos, n칚o incluir v칤deo gen칠rico
        specific_topics = [
            'economia', 'pol칤tica', 'politica', 'elei칞칫es', 'eleicoes',
            'infla칞칚o', 'inflacao', 'd칩lar', 'dolar', 'mercado',
            'governo', 'congresso', 'senado', 'c칙mara', 'camara'
        ]
        
        for keyword in specific_topics:
            if keyword in topic_lower:
                return False  # N칚o incluir v칤deo gen칠rico para temas pol칤ticos/econ칪micos
        
        return False  # Por padr칚o, n칚o incluir v칤deo gen칠rico