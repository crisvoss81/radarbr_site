{% extends 'rb_portal/base.html' %}
{% load static %}
{% load rb_filters %}
{% load markdown_extras %}
{% load cloudinary_extras %}

{% block title %}{{ object.titulo|striptags }} | RadarBR{% endblock %}
{% block meta_description %}{{ object.conteudo|meta_description_from_highlights }}{% endblock %}
<meta name="author" content="RadarBR">
<meta name="keywords" content="{% if object.categoria %}{{ object.categoria.nome }}, {% endif %}notícias, Brasil, {{ object.titulo|striptags|truncatechars:50 }}">
{% block canonical %}{{ SITE_BASE_URL }}{{ object.get_absolute_url }}{% endblock %}

{% block social_meta %}
  {# Open Graph #}
  <meta property="og:type" content="article">
  <meta property="og:title" content="{{ object.titulo|striptags }}">
  <meta property="og:description" content="{{ object.conteudo|striptags|truncatechars:200 }}">
  <meta property="og:url" content="{{ SITE_BASE_URL }}{{ object.get_absolute_url }}">
  {% if object.imagem %}
    <meta property="og:image" content='{% cloudinary_image_url object.imagem width=1200 height=630 crop="fill" %}'>
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
  {% endif %}

  {# Twitter Cards #}
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ object.titulo|striptags }}">
  <meta name="twitter:description" content="{{ object.conteudo|striptags|truncatechars:200 }}">
  {% if object.imagem %}
    <meta name="twitter:image" content='{% cloudinary_image_url object.imagem width=1200 height=630 crop="fill" %}'>
  {% endif %}

  {# JSON-LD Article + Breadcrumbs + FAQ #}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "NewsArticle",
    "headline": "{{ object.titulo|striptags|escapejs }}",
    "datePublished": "{{ object.publicado_em|date:'c' }}",
    "dateModified": "{{ object.publicado_em|date:'c' }}",
    "author": {
      "@type": "Organization",
      "name": "RadarBR",
      "url": "{{ SITE_BASE_URL }}"
    },
    "publisher": {
      "@type": "Organization",
      "name": "RadarBR",
      "url": "{{ SITE_BASE_URL }}",
      "logo": {
        "@type": "ImageObject",
        "url": "{{ SITE_BASE_URL }}{% static 'img/logo-radarbr.png' %}"
      }
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "{{ SITE_BASE_URL }}{{ object.get_absolute_url }}"
    }{% if object.imagem %},
    "image": ["{% cloudinary_image_url object.imagem width=1200 height=630 crop='fill' %}"]{% endif %}{% if object.categoria %},
    "articleSection": "{{ object.categoria.nome|escapejs }}"{% endif %},
    "wordCount": {{ object.conteudo|length }},
    "timeRequired": "PT{% widthratio object.conteudo|length 250 1 %}M"
  }
  </script>
  
  {# Breadcrumbs JSON-LD #}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Home",
        "item": "{{ SITE_BASE_URL }}/"
      }{% if object.categoria %},
      {
        "@type": "ListItem",
        "position": 2,
        "name": "{{ object.categoria.nome|escapejs }}",
        "item": "{{ SITE_BASE_URL }}{{ object.categoria.get_absolute_url }}"
      },
      {
        "@type": "ListItem",
        "position": 3,
        "name": "{{ object.titulo|striptags|escapejs }}",
        "item": "{{ SITE_BASE_URL }}{{ object.get_absolute_url }}"
      }{% else %},
      {
        "@type": "ListItem",
        "position": 2,
        "name": "{{ object.titulo|striptags|escapejs }}",
        "item": "{{ SITE_BASE_URL }}{{ object.get_absolute_url }}"
      }{% endif %}
    ]
  }
  </script>
{% endblock %}

{% block content %}
<article class="post">
  <header class="post-header">
    {% if object.categoria %}<a class="chip" href="{{ object.categoria.get_absolute_url }}">{{ object.categoria.nome }}</a>{% endif %}
    <h1 class="post-title">{{ object.titulo|striptags }}</h1>
    <div class="post-meta">
      Publicado em {{ object.publicado_em|date:'d \d\e F \d\e Y, H\hi' }}
      <span class="reading-time">• {% widthratio object.conteudo|length 250 1 %} min de leitura</span>
    </div>
  </header>

  {% if object.imagem %}
    <figure class="post-figure">
      <img
        src="{{ object.imagem }}"
        width="1200" height="675"
        loading="eager" fetchpriority="high" decoding="async"
        alt="{{ object.imagem_alt|default:object.titulo|striptags }}"
      >
      {% if object.imagem_credito %}
        <figcaption class="muted" style="font-size:.85rem">
          Crédito:
          {% if object.imagem_fonte_url %}
            <a href="{{ object.imagem_fonte_url }}" target="_blank" rel="noopener noreferrer">{{ object.imagem_credito }}</a>
          {% else %}
            {{ object.imagem_credito }}
          {% endif %}
        </figcaption>
      {% endif %}
    </figure>
  {% endif %}

  <div class="post-content">
    {{ object.conteudo|split_content_sections|safe }}
  </div>

  <!-- Artigos Relacionados -->
  {% if related_articles %}
  <section class="related-articles">
    <h2>Artigos Relacionados</h2>
    <div class="related-grid">
      {% for article in related_articles %}
      <article class="related-item">
        <a href="{{ article.get_absolute_url }}" class="related-link">
          {% if article.imagem %}
            <img src="{% cloudinary_image_url article.imagem width=300 height=200 crop='fill' %}" alt="{{ article.imagem_alt|default:article.titulo|striptags }}" class="related-thumb">
          {% endif %}
          <h3 class="related-title">{{ article.titulo|striptags|truncatechars:60 }}</h3>
          <div class="related-meta">{{ article.publicado_em|date:'d/m/Y' }}</div>
        </a>
      </article>
      {% endfor %}
    </div>
  </section>
  {% endif %}
</article>
{% endblock %}